#	 ___      ___  ________  ___  ___  ________
#	|"  \    /"  |/"       )|"  \/"  |/"       )
#	 \   \  //  /(:   \___/  \   \  /(:   \___/
#	  \\  \/. ./  \___  \     \\  \/  \___  \
#	   \.    //    __/  \\    /   /    __/  \\
#	    \\   /    /" \   :)  /   /    /" \   :)
#	     \__/    (_______/  |___/    (_______/
#
# 01010110  01010011  01011001  01010011
#
# Auteur: Virgile de Champigny
#
###########################################################
# FILAMENT
###########################################################

[gcode_macro _EXTRUDE]
description: Extrusion du filament (KlipperScreen "VS")
gcode:
	{% set direction = params.DIR|default("+") %}
	{% set distance = params.DIST|default(50)|float %}
	{% set speed = params.SPEED|default(400)|float %}
	{% if printer.idle_timeout.state == "Printing" and not printer.pause_resume.is_paused %}
		RESPOND TYPE=error MSG="Impossible d'extruder le filament pendant une impression !"
	{% else %}
		{% if printer["filament_switch_sensor filament_sensor"].filament_detected == True or printer["filament_switch_sensor filament_sensor"].enabled == False %}
			{% set temp_pause = printer["gcode_macro PAUSE"].hotend_temp|int %}
			{% set temp_extruder = printer.extruder.temperature|int %}
			{% set temp_min_extrude = printer.configfile.settings['extruder'].min_extrude_temp|int %}
			{% set temp_cible = temp_min_extrude + 10 %}
			{% if temp_pause > 0 %}
				{% set temp_cible = temp_pause %}
				RESPOND MSG="Mise en chauffe de la buse à {temp_pause}°C"
			{% elif printer.extruder.target|int > temp_min_extrude  %}
				{% set temp_cible = printer.extruder.target|int %}
			{% elif temp_extruder < temp_min_extrude  %}
				RESPOND MSG="Mise en chauffe de la buse à {temp_cible}°C"
			{% endif %}
			{% if "xyz" in printer.toolhead.homed_axes %}
				SAVE_GCODE_STATE NAME=EXTRUDE_state
			{% endif %}
			G91
			M106 S0
			M104 S{temp_cible}
			{% if temp_extruder < (temp_cible - 5) %} M109 S{temp_cible} {% endif %}
			G0 E{direction}{distance} F{speed}
			{% if "xyz" in printer.toolhead.homed_axes %}
				M400
				RESTORE_GCODE_STATE NAME=EXTRUDE_state MOVE=0
			{% endif %}
		{% else %}
			RESPOND TYPE=error MSG="Veuillez insérer du filament !"
		{% endif %}
	{% endif %}

#-------------------------------------------------------#

[gcode_macro LOAD_FILAMENT]
description: Chargement du filament
gcode:
	{% set speed = params.SPEED|default(400)|float %}
	{% if printer.idle_timeout.state == "Printing" and not printer.pause_resume.is_paused %}
		RESPOND TYPE=error MSG="Impossible de charger le filament pendant une impression !"
	{% else %}
		{% if printer["filament_switch_sensor filament_sensor"].filament_detected == True or printer["filament_switch_sensor filament_sensor"].enabled == False %}
			{% set temp_pause = printer["gcode_macro PAUSE"].hotend_temp|int %}
			{% set temp_extruder = printer.extruder.temperature|int %}
			{% set temp_min_extrude = printer.configfile.settings['extruder'].min_extrude_temp|int %}
			{% set temp_cible = temp_min_extrude + 10 %}
			{% if temp_pause > 0 %}
				{% set temp_cible = temp_pause %}
				RESPOND MSG="Mise en chauffe de la buse à {temp_pause}°C"
			{% elif printer.extruder.target|int > temp_min_extrude  %}
				{% set temp_cible = printer.extruder.target|int %}
			{% elif temp_extruder < temp_min_extrude  %}
				RESPOND MSG="Mise en chauffe de la buse à {temp_cible}°C"
			{% endif %}
			{% if "xyz" in printer.toolhead.homed_axes %}
				SAVE_GCODE_STATE NAME=LOAD_FILAMENT_state
			{% else %}
				G28
				G1 Z25 F1000
			{% endif %}
			G91
			M106 S0
			M104 S{temp_cible}
			{% if temp_extruder < (temp_cible - 5) %} M109 S{temp_cible} {% endif %}
			RESPOND MSG="Chargement du filament..."
			G0 E500 F400
			G4 P1000
			G0 E50 F200
			{% if "xyz" in printer.toolhead.homed_axes %}
				M400
				RESTORE_GCODE_STATE NAME=LOAD_FILAMENT_state MOVE=0
			{% endif %}
		{% else %}
			RESPOND TYPE=error MSG="Veuillez insérer du filament !"
		{% endif %}
	{% endif %}

#-------------------------------------------------------#

[gcode_macro UNLOAD_FILAMENT]
description: Retrait du filament
gcode:
	{% set speed = params.SPEED|default(400)|float %}
	{% if printer.idle_timeout.state == "Printing" and not printer.pause_resume.is_paused %}
		RESPOND TYPE=error MSG="Impossible de decharger le filament pendant une impression !"
	{% else %}
		{% if printer["filament_switch_sensor filament_sensor"].filament_detected == True or printer["filament_switch_sensor filament_sensor"].enabled == False %}
			{% set temp_pause = printer["gcode_macro PAUSE"].hotend_temp|int %}
			{% set temp_extruder = printer.extruder.temperature|int %}
			{% set temp_min_extrude = printer.configfile.settings['extruder'].min_extrude_temp|int %}
			{% set temp_cible = temp_min_extrude + 10 %}
			{% if temp_pause > 0 %}
				{% set temp_cible = temp_pause %}
				RESPOND MSG="Mise en chauffe de la buse à {temp_pause}°C"
			{% elif printer.extruder.target|int > temp_min_extrude  %}
				{% set temp_cible = printer.extruder.target|int %}
			{% elif temp_extruder < temp_min_extrude  %}
				RESPOND MSG="Mise en chauffe de la buse à {temp_cible}°C"
			{% endif %}
			{% if "xyz" in printer.toolhead.homed_axes %}
				SAVE_GCODE_STATE NAME=UNLOAD_FILAMENT_state
			{% else %}
				G28
				G1 Z25 F1000
			{% endif %}
			G91
			M104 S{temp_cible}
			{% if temp_extruder < (temp_cible - 5) %} M109 S{temp_cible} {% endif %}
			RESPOND MSG="Retrait du filament..."
			G0 E50 F400
			G0 E-50 F1000
			G0 E-450 F2000
			{% if "xyz" in printer.toolhead.homed_axes %}
				M400
				RESTORE_GCODE_STATE NAME=UNLOAD_FILAMENT_state MOVE=0
			{% endif %}
		{% else %}
			RESPOND TYPE=error MSG="Rien à décharger !"
		{% endif %}
	{% endif %}

#-------------------------------------------------------#

[gcode_macro EXTRUDEUR_CALIBRATION]
description: Calibration extrudeur
# rotation_distance = <previous_rotation_distance> * <actual_extrude_distance> / <requested_extrude_distance>
gcode:
	{% set temp_extrude = 220 %}
	{% if printer.idle_timeout.state == "Printing" %}
		RESPOND TYPE=error MSG="Impossible de faire la calibration extrudeur pendant une impression!"
	{% else %}
		{% if printer["filament_switch_sensor filament_sensor"].filament_detected == True or printer["filament_switch_sensor filament_sensor"].enabled == False %}
			M106 S0
			{% if printer.extruder.temperature < (temp_extrude - 5) %}
				RESPOND MSG="Mise en chauffe de la buse à {temp_extrude}°C"
				M109 S{temp_extrude}
			{% endif %}
			M104 S{temp_extrude}
			M83
			G28
			G92 E0
			G1 F100 E100
			M400
			RESPOND MSG="Veuillez mesurer les 20mm de filament restant.."
		{% else %}
			RESPOND TYPE=error MSG="Veuillez insérer du filament !"
		{% endif %}
	{% endif %}
